<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>AR - CÃ¢mera Sempre Ativa</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- AR.js com suporte total -->
    <script src="https://cdn.jsdelivr.net/npm/ar.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
      }
      body {
        width: 100%;
        height: 100vh;
        font-family: monospace;
        background: #000;
        color: #0f0;
        overflow: hidden;
      }

      html,
      body {
        width: 100%;
        height: 100%;
      }

      a-scene {
        width: 100%;
        height: 100%;
        display: block;
      }

      #status {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.95);
        padding: 15px;
        border-radius: 5px;
        z-index: 999;
        font-size: 12px;
        line-height: 1.6;
      }

      .ok {
        color: #0f0;
      }
      .erro {
        color: #f00;
      }
      .warn {
        color: #ff0;
      }

      #instrucoes {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.95);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        max-width: 90%;
        font-size: 13px;
      }

      a {
        color: #0ff;
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div id="status">
      <strong style="color: #0ff">ðŸ“± AR COM CÃ‚MERA ATIVA</strong><br /><br />
      PÃ¡gina: <span id="page" class="ok">âœ“</span><br />
      A-Frame: <span id="af" class="warn">âŸ³</span><br />
      AR.js: <span id="ar" class="warn">âŸ³</span><br />
      CÃ¢mera: <span id="cam" class="warn">âŸ³</span><br />
      Marcador: <span id="marker" class="erro">âŸ³ scanning</span><br /><br />
      <small id="msg">Inicializando...</small>
    </div>

    <div id="instrucoes">
      ðŸ“‹ <strong>APONTE PARA O MARCADOR HIRO</strong><br /><br />
      <a
        href="https://jeromeetienne.github.io/AR.js/data/images/HIRO.jpg"
        target="_blank"
      >
        ðŸ‘‰ Ver marcador HIRO </a
      ><br />
      <small>(Imprima em A4 ou exiba na tela)</small>
    </div>

    <!-- CENA AR - Simples e direta -->
    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono; matrixCodeType: 3x3;"
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true;"
      id="arScene"
    >
      <a-camera-static></a-camera-static>

      <!-- Marcador Customizado -->
      <a-marker type="pattern" url="pattern-marker.patt" emitevents="true">
        <!-- Modelo GLB -->
        <a-gltf-model
          src="#model-glb"
          position="0 0 0"
          scale="1 1 1"
          animation="property: rotation; to: 0 360 0; dur: 4000; loop: true"
        >
        </a-gltf-model>
      </a-marker>

      <!-- Assets -->
      <a-assets timeout="30000">
        <a-asset-item id="model-glb" src="model1.glb"></a-asset-item>
      </a-assets>
    </a-scene>

    <script>
      console.log("=== INICIANDO AR ===");
      document.getElementById("page").textContent = "âœ“";

      // ===== ESPERAR AFRAME =====
      function waitForAFrame() {
        return new Promise((resolve) => {
          if (window.AFRAME && AFRAME.version) {
            resolve();
          } else {
            const checkInterval = setInterval(() => {
              if (window.AFRAME && AFRAME.version) {
                clearInterval(checkInterval);
                resolve();
              }
            }, 100);
            setTimeout(() => clearInterval(checkInterval), 5000);
          }
        });
      }

      // ===== ESPERAR AR.JS =====
      function waitForARjs() {
        return new Promise((resolve) => {
          if (window.THREEx) {
            resolve();
          } else {
            const checkInterval = setInterval(() => {
              if (window.THREEx) {
                clearInterval(checkInterval);
                resolve();
              }
            }, 100);
            setTimeout(() => clearInterval(checkInterval), 5000);
          }
        });
      }

      // ===== INICIALIZAÃ‡ÃƒO =====
      async function init() {
        try {
          // Esperar A-Frame
          console.log("Aguardando A-Frame...");
          await waitForAFrame();
          document.getElementById("af").textContent = "âœ“";
          document.getElementById("af").className = "ok";
          console.log("âœ“ A-Frame carregado:", AFRAME.version);

          // Esperar AR.js
          console.log("Aguardando AR.js...");
          await waitForARjs();
          document.getElementById("ar").textContent = "âœ“";
          document.getElementById("ar").className = "ok";
          console.log("âœ“ AR.js carregado");

          // Esperar cena
          console.log("Aguardando cena A-Frame...");
          const scene = document.querySelector("a-scene");
          if (scene) {
            await new Promise((resolve) => {
              scene.addEventListener("loaded", resolve);
              setTimeout(resolve, 3000);
            });
            console.log("âœ“ Cena carregada");
          }

          // CÃ¢mera
          console.log("Solicitando cÃ¢mera...");
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 1280 },
              height: { ideal: 720 },
            },
          });

          document.getElementById("cam").textContent = "âœ“";
          document.getElementById("cam").className = "ok";
          console.log("âœ“ CÃ¢mera autorizada e ativa");
          document.getElementById("msg").textContent =
            "CÃ¢mera ativa - Escaneie HIRO!";

          // NÃƒO fechar o stream!
          // stream.getTracks().forEach(t => t.stop());
        } catch (error) {
          console.error("ERRO:", error);
          document.getElementById("msg").textContent = `Erro: ${error.message}`;
        }
      }

      // Iniciar apÃ³s documento carregar
      document.addEventListener("DOMContentLoaded", init);
      window.addEventListener("load", () => {
        console.log("PÃ¡gina totalmente carregada");
      });

      // ===== EVENTOS DO MARCADOR =====
      document.addEventListener("markerFound", () => {
        console.log("â­ MARCADOR HIRO ENCONTRADO!");
        document.getElementById("marker").textContent = "âœ“ DETECTADO";
        document.getElementById("marker").className = "ok";
        document.getElementById("msg").textContent = "â­ Modelo aparecendo!";
      });

      document.addEventListener("markerLost", () => {
        console.log("Marcador perdido");
        document.getElementById("marker").textContent = "âŸ³ scanning";
        document.getElementById("marker").className = "erro";
        document.getElementById("msg").textContent = "Procurando marcador...";
      });

      console.log("Script pronto");
    </script>
  </body>
</html>
